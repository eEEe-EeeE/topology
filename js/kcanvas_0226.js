function EntityGroup(id,name,x,y,width,height,_color){ShapeEntity.call(this,id,name,x,y,width,height);var superMoveOft=this.moveOft;var me=this;var superPaint=me.paint;var members=[];var color=_color?_color:"black";var backgroundColor="eeeeee#";this.getType=function(){return"group"};this.setColor=function(c){color=c};this.getColor=function(){return color};this.setBackgroundColor=function(c){backgroundColor=c};this.getBackgroundColor=function(){return backgroundColor};this.addMember=function(obj){for(var i=0;i<members.length;i++){if(members[i]==obj){return}}members[members.length]=obj;obj.inGroup(true)};this.removeMember=function(obj){var n=-1;var ns=[];for(var i=0;i<members.length;i++){if(members[i]==obj){n=i;obj.inGroup(false);continue}ns[ns.length]=members[i]}if(n<0){return null}var rs=members[n];members=ns;return rs};this.getMembers=function(){return members};this.moveOft=function(ln){superMoveOft(ln);for(var i=0;i<members.length;i++){if(members[i].isSelected()){continue}members[i].moveOft(ln)}};var drawDashLine=function(ctx,x1,y1,x2,y2,stepOft){var step=stepOft?stepOft:5;var x=x2-x1;var y=y2-y1;var count=Math.floor(Math.sqrt(x*x+y*y)/step);var xv=x/count;var yv=y/count;ctx.beginPath();for(var i=0;i<count;i++){if(i%2===0){ctx.moveTo(x1,y1)}else{ctx.lineTo(x1,y1)}x1+=xv;y1+=yv}ctx.lineTo(x2,y2)};var drawDashRect=function(ctx,left,top,width,height,stepOft){var step=stepOft?stepOft:5;drawDashLine(ctx,left+3,top,left+width,top,step);ctx.stroke();drawDashLine(ctx,left+width,top,left+width,top+height-3,step);ctx.stroke();drawDashLine(ctx,left+width,top+height,left+3,top+height,step);ctx.stroke();drawDashLine(ctx,left,top+height,left,top+3,step);ctx.stroke()};this.paint=function(ctx){ctx.save();superPaint(ctx);var b=me.bounds();drawDashRect(ctx,b.x,b.y,b.width,b.height);if(backgroundColor){ctx.fillStyle=backgroundColor;ctx.globalAlpha=0.1;ctx.fillRect(b.x,b.y,b.width,b.height)}ctx.restore()}};
function EntityEditor(_canvas,_editor,obj){var entity=obj;var canvas=_canvas;var editor=_canvas.getEntityEditor();var me=this;var width=0;this.show=function(x,y,ev){var ln=entity.getNamePaintLocation();editor.style.top=ln.y;editor.style.left=ln.x;editor.style.height=ln.h<20?20:ln.h;editor.value=entity.getName()};this.setWidth=function(w){width=w};this.autoResizeEditorField=function(){};this.hidden=function(){editor.style.top=-100;editor.style.left=-100;editor.value=""};this.update=function(){entity.setName(me.getEditorValue())};this.getEditorValue=function(){return editor.value};this.focus=function(){editor.focus();editor.select()};this.autoResizeEditorField=function(){var bounds=canvasTextBounds("15px",me.getEditorValue());var w=Math.max(width,bounds.width);editor.style.width=w+"px"}}function ImageEditor(_canvas,_editor,obj){EntityEditor.call(this,_canvas,_editor,obj);var canvas=_canvas;var entity=obj;var me=this;this.show=function(x,y,ev){var ln=entity.getNamePaintLocation();editor.style.top=ln.y+(ev.screenY-y);editor.style.left=ln.x+12;editor.style.height=ln.h<20?20:ln.h;var bounds=canvasTextBounds("15px",entity.getName());var w=Math.max(ln.w,bounds.width);me.setWidth(w);editor.style.width=w+"px";editor.value=entity.getName()};this.update=function(){entity.setName(me.getEditorValue())}}function TextEditor(_canvas,_editor,obj){EntityEditor.call(this,_canvas,_editor,obj);var canvas=_canvas;var entity=obj;var me=this;this.show=function(x,y,ev){var ln=entity.getNamePaintLocation();var height=ln.h<20?20:ln.h;editor.value=entity.getContent();editor.style.height=height;editor.style.top=ln.y+(51-height);editor.style.left=ln.x+10;var w=ln.w*7.5;me.setWidth(w);editor.style.width=w+"px"};this.update=function(){entity.setContent(me.getEditorValue())}}function LineEditor(_canvas,_editor,obj){EntityEditor.call(this,_canvas,_editor,obj);EntityEditor.call(this,_canvas,_editor,obj);var canvas=_canvas;var entity=obj;var me=this;this.autoResizeEditorField=function(){}};
function ShapeEntity(id,name,x,y,width,height){Shape.call(this,id,name);var me=this;var superPaint=me.paint;var lines=[];this.getType=function(){return"entity"};this.isEntity=function(){return true};this.addLine=function(line){for(var i=0;i<lines.length;i++){if(lines[i]==line){return}}lines[lines.length]=line};this.getLines=function(){return lines};this.getEntitySin=function(){var h=me.getHeight();var w=me.getWidth();return h/Math.sqrt(h*h+w*w)};this.paint=function(ctx){superPaint(ctx)};this.reLocationLines=function(){if(!lines){return}for(var i=0;i<lines.length;i++){lines[i].relocationFrom();lines[i].relocationTo()}};this.bounds=function(){var b={};b.x=me.getX();b.y=me.getY();b.width=me.getWidth();b.height=me.getHeight();return b};if(x){me.setX(autoParseNumber(x))}if(y){me.setY(autoParseNumber(y))}if(width){me.setWidth(autoParseNumber(width,32))}if(height){me.setHeight(autoParseNumber(height,32))}};
function Line(id,name,x1,y1,_x2,_y2,lineWidthValue,lineColor){Shape.call(this,id,name);var me=this;var superPaint=me.paint;var lineWidth=autoParseNumber(lineWidthValue,1);var x2=autoParseNumber(_x2,0);var y2=autoParseNumber(_y2,0);var color=lineColor?lineColor:"black";var nameColor="black";var fromObj;var toObj;var fromComment="";var toComment="";var isShowArrow=false;me.setX(x1);me.setY(y1);this.getType=function(){return"line"};this.setX2=function(x){x2=autoParseNumber(x,0)};this.setY2=function(y){y2=autoParseNumber(y,0)};this.isShowArrow=function(){return isShowArrow};this.showArrow=function(o){isShowArrow=o};this.moveOft=function(ln){me.setX(me.getX()+ln.x);me.setX2(me.getX2()+ln.x);me.setY(me.getY()+ln.y);me.setY2(me.getY2()+ln.y)};this.getX2=function(){return x2};this.getY2=function(){return y2};this.setLineWidth=function(lw){lineWidth=autoParseNumber(lw,1)};this.getLineWidth=function(){return lineWidth};this.setLineColor=function(lineColor){color=lineColor};this.getLineColor=function(){return color};this.setNameColor=function(c){nameColor=c};this.getNameColor=function(){return nameColor};this.setFromComment=function(comment){fromComment=comment};this.getFromComment=function(){return fromComment};this.setToComment=function(comment){toComment=comment};this.getToComment=function(){return toComment};this.setFromObj=function(obj){fromObj=obj;me.setX(obj.getCenterX());me.setY(obj.getCenterY());obj.addLine(me)};this.getFromObj=function(){return fromObj};this.setToObj=function(obj){toObj=obj;me.setX2(obj.getCenterX());me.setY2(obj.getCenterY());obj.addLine(me)};this.getToObj=function(){return toObj};this.clone=function(){var rs=new Line(uuid(),me.getName(),me.getX(),me.getY(),me.getX2(),me.getY2(),me.getLineWidth(),me.getLineColor());rs.setFromComment(me.getFromComment());rs.setToComment(me.getToComment());rs.setShadowColor(me.getShadowColor());rs.setShadowBlur(me.getShadowBlur());return rs};this.paint=function(ctx){superPaint(ctx);if(me.isShowArrow()){drawArrow(ctx,me.getX(),me.getY(),me.getX2(),me.getY2(),null,null,lineWidth,color)
}else{drawLine(ctx,me.getX(),me.getY(),me.getX2(),me.getY2(),lineWidth,color)}me.paintLabelStyle(ctx);var tx=(me.getX()+me.getX2())/2;var ty=(me.getY()+me.getY2())/2;ctx.fillStyle=nameColor;ctx.fillText(me.getName(),tx,ty);var mx=me.getX()-me.getX2(),my=me.getY()-me.getY2();var h=Math.sqrt(mx*mx+my*my);h=Math.sqrt(h);h=Math.sqrt(h);h=h/0.67;var oftH=h;var bs=canvasTextBounds("15px",me.getFromComment());tx=me.getX()-mx/oftH-bs.width/2;ty=me.getY()-my/oftH;ctx.fillText(me.getFromComment(),tx,ty);bs=canvasTextBounds("15px",me.getToComment());tx=me.getX2()+mx/oftH-bs.width/2;ty=me.getY2()+my/oftH;ctx.fillText(me.getToComment(),tx,ty)};var getRelocationOft=function(mx,my){var rs={};var pf=me.getFromObj().getCenterPoint();var pt=me.getToObj().getCenterPoint();rs.fromX=pf.x;rs.fromY=pf.y;rs.toX=pt.x;rs.toY=pt.y;var mx=pf.x-pt.x,my=pf.y-pt.y;var h=Math.sqrt(mx*mx+my*my);h=Math.sqrt(h);h=Math.sqrt(h);h=h/0.33;rs.x=mx;rs.y=my;rs.h=h;return rs};this.relocationFrom=function(){var oft=getRelocationOft();var tx=oft.fromX-oft.x/oft.h;var ty=oft.fromY-oft.y/oft.h;me.setX(tx);me.setY(ty)};this.relocationTo=function(){var oft=getRelocationOft();var tx=oft.toX+oft.x/oft.h;var ty=oft.toY+oft.y/oft.h;me.setX2(tx);me.setY2(ty)};this.bounds=function(){var b={};b.x=Math.min(me.getX(),me.getX2());b.y=Math.min(me.getY(),me.getY2());b.width=Math.abs(me.getX()-me.getX2());b.height=Math.abs(me.getY()-me.getY2());return b};this.getNamePaintLocation=function(){var rs={};rs.x=me.getX();rs.y=superGetY();rs.w=me.getWidth();rs.h=me.getHeight();rs.y=rs.y-rs.h/2;rs.x=rs.x+10;return rs};this.getEditValue=function(){return me.getContent()};this.isIn=function(px,py){var oft=13;if((px-oft)>Math.max(me.getX(),me.getX2())||(px+oft)<Math.min(me.getX(),me.getX2())||(py-oft)>Math.max(me.getY(),me.getY2())||(py+oft)<Math.min(me.getY(),me.getY2())){return false}var X1=(me.getX()-px),Y1=(me.getY()-py);if(Math.abs(X1)<oft&&Math.abs(Y1)<oft){return false}var X2=(me.getX()-me.getX2()),Y2=(me.getY()-me.getY2());if(Math.abs(X2)<oft&&Math.abs(Y2)<oft){return false
}var tv=0.5;X1=X1==0?tv:X1;Y1=Y1==0?tv:Y1;var asin1=Math.asin(X1/Math.sqrt(X1*X1+Y1*Y1));var asin2=Math.asin(X2/Math.sqrt(X2*X2+Y2*Y2));var sin=Math.sin((asin1-asin2));var h=(sin*Math.sqrt(X1*X1+Y1*Y1));return h<oft&&h>(-1*oft)};this.canMoving=function(){return false};var editor=null;this.getEditor=function(canvas){if(editor==null){editor=new LineEditor(canvas,null,me)}return editor};var drawLine=function(ctx,fromX,fromY,toX,toY,width,color){width=width?width:1;color=color?color:"#000";ctx.save();ctx.strokeStyle=color;ctx.lineWidth=width;ctx.beginPath();ctx.moveTo(fromX,fromY);ctx.lineTo(toX-3,toY-3);ctx.stroke();ctx.restore()};var drawArrow=function(ctx,fromX,fromY,toX,toY,theta,headlen,width,color){theta=theta?theta:30;headlen=headlen?headlen:10;width=width?width:1;color=color?color:"#000";var angle=Math.atan2(fromY-toY,fromX-toX)*180/Math.PI,angle1=(angle+theta)*Math.PI/180,angle2=(angle-theta)*Math.PI/180,topX=headlen*Math.cos(angle1),topY=headlen*Math.sin(angle1),botX=headlen*Math.cos(angle2),botY=headlen*Math.sin(angle2);ctx.save();ctx.beginPath();var arrowX=fromX-topX,arrowY=fromY-topY;ctx.moveTo(arrowX,arrowY);ctx.moveTo(fromX,fromY);ctx.lineTo(toX,toY);arrowX=toX+topX;arrowY=toY+topY;ctx.moveTo(arrowX,arrowY);ctx.lineTo(toX,toY);arrowX=toX+botX;arrowY=toY+botY;ctx.lineTo(arrowX,arrowY);ctx.strokeStyle=color;ctx.lineWidth=width;ctx.stroke();ctx.restore()};this.toString=function(){return'{id:"'+me.getId()+'",type:"'+me.getType()+'",name:"'+me.getName()+'",x1:'+me.getX()+",y1:"+me.getY()+",x2:"+me.getX2()+",y2:"+me.getY2()+',color:"'+color+'",lineWidth:'+lineWidth+((fromObj&&toObj)?(',fromObj:"'+fromObj.getId()+'",toObj:"'+toObj.getId()+'"'):"")+',fromComment:"'+fromComment+'",toComment:"'+toComment+'",isShowArrow:'+isShowArrow+',shadowColor:"'+me.getShadowColor()+'",shadowBlur:'+me.getShadowBlur()+"}"}};
function CanvasUtil(){this.imageLibrary=[];var me=this;var image_entities_library_id="canvas_imageLibrary";this.importEntities=function(canvas,json){var doc=json.doc;var entities=json.entities;if(doc.name){name=doc.name}if(doc.width){canvas.width=doc.width}if(doc.height){canvas.height=doc.height}if(entities){for(var i=0;i<entities.length;i++){var obj=generateEntity(canvas,entities[i],json.libraries);canvas.addItem(obj)}for(var i=0;i<entities.length;i++){if(entities[i].properties){initRelationWhenImport(canvas,entities[i])}}}if(json.libraries){canvas.setLibraries(json.libraries)}setTimeout(function(){canvas.repaint()},300)};this.exportEntitiesToJson=function(canvas){var json={};var doc={};var bounds=canvas.getBounds();doc.width=bounds.width;doc.height=bounds.height;json.doc=doc;json.libraries={};var entities=[];var items=canvas.getItems();for(var i=0;i<items.length;i++){var item=items[i];var entity={};entity.id=item.getId();entity.name=item.getName();entity.type=item.getType();var atts=item.getExtProperties();if(item.getType()=="image"){initImagePropertiesWhenExport(item,atts,json.libraries)}else{if(item.getType()=="line"){initLinePropertiesWhenExport(item,atts)}else{if(item.getType()=="text"){initTextPropertiesWhenExport(item,atts)}else{if(item.getType()=="group"){initGroupPropertiesWhenExport(item,atts)}}}}initPropertiesDefWhenExport(item,atts);entity.properties=atts;entities[entities.length]=entity}json.entities=entities;json=JSON.stringify(json);return json};var initPropertiesDefWhenExport=function(item,atts){if(item.getShadowBlur()&&item.getShadowColor()){var sdc={};sdc.name="shadowColor";sdc.value=item.getShadowColor();var sdb={};sdb.name="shadowBlur";sdb.value=item.getShadowBlur();filterProperty(atts,sdc);filterProperty(atts,sdb)}var font={};font.name="font";font.value=item.getLabelFont();var fontSize={};fontSize.name="fontSize";fontSize.value=item.getLabelFontSize();var fontColor={};fontColor.name="fontColor";fontColor.value=item.getLabelFontColor();filterProperty(atts,font);
filterProperty(atts,fontSize);filterProperty(atts,fontColor)};var initImagePropertiesWhenExport=function(item,atts,libs){var x={};x.name="x";x.value=item.getX();var y={};y.name="y";y.value=item.getY();var w={};w.name="width";w.value=item.getWidth();var h={};h.name="height";h.value=item.getHeight();var iType={};iType.name="imageType";iType.value=item.getImageType();var tm={};tm.name="topComment";tm.value=item.getTopComment()?item.getTopComment():"";filterProperty(atts,x);filterProperty(atts,y);filterProperty(atts,w);filterProperty(atts,h);if(iType.value){filterProperty(atts,iType)}filterProperty(atts,tm);var imgType=getProperty("imageType",item.getExtProperties());var src=item.getImage().src;var lib={name:imgType,value:src};var imgs=libs.imgs?libs.imgs:[];filterProperty(imgs,lib);libs.imgs=imgs};var initLinePropertiesWhenExport=function(item,atts){var w={};w.name="lineWidth";w.value=item.getLineWidth();var from={};from.name="from";from.value=item.getFromObj().getId();var to={};to.name="to";to.value=item.getToObj().getId();var c={};c.name="lineColor";c.value=item.getLineColor();var nc={};nc.name="nameColor";nc.value=item.getNameColor();var sa={};sa.name="showArrow";sa.value=item.isShowArrow();var fromComment={};fromComment.name="fromComment";fromComment.value=item.getFromComment();var toComment={};toComment.name="toComment";toComment.value=item.getToComment();filterProperty(atts,w);filterProperty(atts,from);filterProperty(atts,to);filterProperty(atts,c);filterProperty(atts,nc);filterProperty(atts,sa);filterProperty(atts,fromComment);filterProperty(atts,toComment)};var initTextPropertiesWhenExport=function(item,atts){var x={};x.name="x";x.value=item.getX();var y={};y.name="y";y.value=item.getY();var txt={};txt.name="content";txt.value=item.getContent();filterProperty(atts,x);filterProperty(atts,y);filterProperty(atts,txt)};var initGroupPropertiesWhenExport=function(item,atts){var x={};x.name="x";x.value=item.getX();var y={};y.name="y";y.value=item.getY();var w={};w.name="width";
w.value=item.getWidth();var h={};h.name="height";h.value=item.getHeight();var c={};c.name="color";c.value=item.getColor();var bc={};bc.name="backgroundColor";bc.value=item.getBackgroundColor();filterProperty(atts,x);filterProperty(atts,y);filterProperty(atts,w);filterProperty(atts,h);filterProperty(atts,c);filterProperty(atts,bc);var members=item.getMembers();if(members&&members.length>0){var ids="";for(var i=0;i<members.length;i++){if(i>0){ids+=","}ids+=members[i].getId()}var items={};items.name="members";items.value=ids;filterProperty(atts,items)}};var filterProperty=function(atts,p){for(var i=0;i<atts.length;i++){if(atts[i].name==p.name){atts[i].value=p.value;return}}atts[atts.length]=p};var generateEntity=function(canvas,data,libs){var rs;switch(data.type){case"image":var imgObj=getEntityImageElementFromLibrary(canvas,data.properties,libs);if(imgObj==null){imgObj=getEntityImageElement(data.properties)}rs=new Image(data.id,data.name,imgObj);break;case"line":rs=new Line(data.id,data.name);break;case"group":rs=new EntityGroup(data.id,data.name);break;case"text":rs=new Text(data.id,data.name);break}if(rs){initEntityProperties(rs,data.properties)}return rs};var initRelationWhenImport=function(canvas,entityData){var obj=canvas.getItem(entityData.id);if(obj==null){return}obj.setExtProperties(entityData.entities);if(entityData.type=="line"){var line=obj;var fromId=getProperty("from",entityData.properties);var toId=getProperty("to",entityData.properties);var from=canvas.getItem(fromId);var to=canvas.getItem(toId);if(from&&to){line.setFromObj(from);line.setToObj(to);from.addLine(line);to.addLine(line);line.relocationFrom();line.relocationTo()}}else{if(entityData.type=="group"){var mstr=getProperty("members",entityData.properties);if(mstr){var marr=mstr.split(",");for(var i=0;i<marr.length;i++){var member=canvas.getItem(marr[i]);if(member){obj.addMember(member)}}}}}};var initEntityProperties=function(entity,properties){for(var i=0;i<properties.length;i++){var item=properties[i];
entity.addExtProperties(item);try{switch(item.name){case"x":entity.setX(item.value);continue;case"y":entity.setY(item.value);continue;case"width":entity.setWidth(item.value);continue;case"height":entity.setHeight(item.value);continue;case"content":entity.setContent(item.value);continue;case"shadowColor":entity.setShadowColor(item.value);continue;case"lineWidth":entity.setLineWidth(item.value);continue;case"shadowBlur":entity.setShadowBlur(item.value);continue;case"font":entity.setLabelFont(item.value);continue;case"color":entity.setColor(item.value);continue;case"nameColor":entity.setNameColor(item.value);continue;case"showArrow":entity.showArrow(item.value);continue;case"topComment":entity.setTopComment(item.value);continue;case"fontSize":entity.setLabelFontSize(item.value);continue;case"fontColor":entity.setLabelFontColor(item.value);continue;case"lineColor":entity.setLineColor(item.value);continue;case"fromComment":entity.setFromComment(item.value);continue;case"toComment":entity.setToComment(item.value);continue;case"imageType":entity.setImageType(item.value);continue;case"backgroundColor":entity.setBackgroundColor(item.value);continue;case"members":continue}}catch(e){console.log(e)}}};var getEntityImageElementFromLibrary=function(canvas,properties,libs){var imgType=getProperty("imageType",properties);var src=null;if(canvas.getImageSrcPath){src=canvas.getImageSrcPath(imgType)}if(src==null){src=getProperty(imgType,libs.imgs)}console.log("image path type:"+imgType,src);if(src){var img=me.imageLibrary[src];if(img){return img}var len=src.length;if(false&&src.toLocaleLowerCase().indexOf(".svg")==(len-4)){var templateNode=null;var image=templateNode?templateNode.cloneNode():document.createElement("IMG");img=document.createElementNS("http://www.w3.org/2000/svg","image");img.namespaceURI="http://www.w3.org/1999/xhtml";img.href.baseVal=src;image.appendChild(img);console.log("create img:",img);console.log("create image:",image)}else{img=document.createElement("IMG");img.src=src
}return img}return null};var getEntityImageElement=function(properties){var lib=document.getElementById(image_entities_library_id);if(lib&&lib.childNodes){var images=lib.childNodes;var imgType=getProperty("imageType",properties);for(var i=0;i<images.length;i++){var obj=images.item(i);if(obj.nodeType!=1){continue}var img=obj;if(img.getAttribute("type")==imgType){return img}}}return null};var getProperty=function(property,properties){for(var i=0;i<properties.length;i++){var item=properties[i];if(item.name==property){return item.value}}return null}};
function ActionRecorder(canvas){var canvas=canvas;var actionPintterBuffer=[];this.performDoCancel=function(index){var r=actionPintterBuffer[index];r.cancel()};this.recordAction=function(record,index){}};
function Image(id,name,imgObj,x,y,width,height){ShapeEntity.call(this,id,name,x,y,width,height);var me=this;var img=imgObj?imgObj:createBlankImage();var imageType;var superPaint=me.paint;var topComment;if(!width){me.setWidth(img&&img.width?img.width:32)}if(!height){me.setHeight(img&&img.height?img.height:32)}this.getType=function(){return"image"};this.setImage=function(imgObj){img=imgObj};this.getImage=function(){return img};this.setImageType=function(obj){imageType=obj};this.getImageType=function(){return imageType};this.clone=function(){var w=me.getWidth();var h=me.getHeight();var rs=new Image(uuid(),me.getName(),me.getImage(),me.getX()+w+32,me.getY()+h+32,w,h);rs.setLabelFontColor(me.getLabelFontColor());rs.setLabelFont(me.getLabelFont());rs.setLabelFontSize(me.getLabelFontSize());rs.setShadowColor(me.getShadowColor());rs.setShadowBlur(me.getShadowBlur());rs.setImageType(me.getImageType());return rs};this.setTopComment=function(str){topComment=str};this.getTopComment=function(){return topComment};this.paint=function(ctx){superPaint(ctx);ctx.drawImage(me.getImage(),me.getX(),me.getY(),me.getWidth(),me.getHeight());me.paintLabelStyle(ctx);var ln=null;var lab=me.getName();var b=canvasTextBounds(me.getLabelFontSize(),lab);var arr=lab.split("\n");for(var i=0;i<arr.length;i++){ln=me.getNamePaintLocation(arr[i]);ctx.fillText(arr[i],ln.x,ln.y+i*b.height)}ln=me.getNamePaintLocation(lab);if(me.getTopComment()){ctx.fillText(me.getTopComment(),ln.topX,ln.topY)}};this.getNamePaintLocation=function(lab){var bounds=canvasTextBounds(me.getLabelFontSize(),lab);var ln={};var tx=me.getX()+(me.getWidth()-bounds.width)/2;var ty=me.getY()+me.getHeight()+3+bounds.height;if(me.getTopComment()){var bt=canvasTextBounds(me.getLabelFontSize(),me.getTopComment());ln.topY=ty-bounds.height-me.getHeight()-6;ln.topX=me.getX()+(me.getWidth()-bt.width)/2}ln.x=tx;ln.y=ty;ln.w=bounds.width;ln.h=bounds.height;return ln};var editor=null;this.getEditor=function(canvas){if(editor==null){editor=new ImageEditor(canvas,null,me)
}return editor};this.toString=function(){return'{id:"'+me.getId()+'",type:"'+me.getType()+'",name:"'+me.getName()+'",x:'+me.getX()+",y:"+me.getY()+",width:"+me.getWidth()+",height:"+me.getHeight()+',imageType:"'+me.getImageType()+'"'+',shadowColor:"'+me.getShadowColor()+'",shadowBlur:"'+(me.getShadowBlur()?me.getShadowBlur():"")+'"'+',topComment:"'+me.getTopComment()+'"'+"}"}};
function FlickerPoint(id,name,x,y,width,_flickColor){ShapeEntity.call(this,id,name,x,y,width,width);var me=this;var img=imgObj;var superPaint=me.paint;var flickColor=_flickColor;this.getType=function(){return"flicker"};this.setFlickColor=function(_flickColor){flickColor=_flickColor};this.getFlickColor=function(){return flickColor?flickColor:"red"};var isFlicker=false;this.paint=function(ctx){superPaint(ctx);isFlicker=!isFlicker;var color=isFlicker?me.getFlickColor():"white";ctx.fillStyle=color;ctx.arc(me.getX(),me.getY(),me.getWidth(),0,2*Math.PI);ctx.fill();if(me.getName()){me.paintLabelStyle(ctx);var tx=me.getX()+me.getWidth();var ty=me.getY();ctx.fillText(me.getName(),tx,ty)}}};
function Shape(idInf,nameInf){var me=this;var id=idInf;var name=nameInf;var x=100,x2;var y=100,y2;var width=32;var height=32;var oftX=0;var oftY=0;var selectedFlag=false;var labelFont="Arial";var labelFontSize="15px";var labelFontColor="black";var shadowColor="black";var shadowBlur=-1;var isInGroup=false;this.inGroup=function(o){isInGroup=o};this.isInGroup=function(){return isInGroup};var extProperties=[];this.getExtProperties=function(){return extProperties};this.setExtProperties=function(atts){if(atts){extProperties=atts}};this.addExtProperties=function(att){for(var i=0;i<extProperties.length;i++){if(extProperties[i].name==att.name){extProperties[i].value=att.value;return}}extProperties[extProperties.length]=att};this.getType=function(){return"shape"};this.isEntity=function(){return false};this.getId=function(){return id};this.getName=function(){return name};this.setName=function(str){name=str};this.getX=function(){return x};this.getY=function(){return y};this.getOftX=function(){return oftX};this.getCenterX=function(){return x+me.getWidth()/2};this.getCenterY=function(){return y+me.getHeight()/2};this.getCenterPoint=function(){var p={};p.x=me.getCenterX();p.y=me.getCenterY();return p};this.getOftY=function(){return oftY};this.getWidth=function(){return width};this.getHeight=function(){return height};this.moveOft=function(ln){me.setX(x+ln.x);me.setY(y+ln.y)};this.setX=function(x1){x=autoParseNumber(x1,0);if(me.reLocationLines){me.reLocationLines()}};this.setY=function(y1){y=autoParseNumber(y1,0);if(me.reLocationLines){me.reLocationLines()}};this.setWidth=function(w){width=autoParseNumber(w,32);if(me.reLocationLines){me.reLocationLines()}};this.setHeight=function(h){height=autoParseNumber(h,32);if(me.reLocationLines){me.reLocationLines()}};this.setLabelFont=function(_labelFont){labelFont=_labelFont};this.getLabelFont=function(){return labelFont};this.setLabelFontSize=function(_labelFontSize){labelFontSize=_labelFontSize};this.getLabelFontSize=function(){return labelFontSize
};this.setLabelFontColor=function(_labelFontColor){labelFontColor=_labelFontColor};this.getLabelFontColor=function(){return labelFontColor?labelFontColor:"black"};this.setShadowBlur=function(level){shadowBlur=level};this.getShadowBlur=function(){return shadowBlur};this.setShadowColor=function(scolor){shadowColor=scolor};this.getShadowColor=function(){return shadowColor};this.canMoving=function(){return true};this.isIn=function(px,py){oftX=px-x;oftY=py-y;var rs=oftX>0&&oftX<me.getWidth()&&oftY>0&&oftY<height;return rs};this.selected=function(o){selectedFlag=o};this.isSelected=function(){return selectedFlag};this.paint=function(ctx){if(me.getShadowBlur()&&me.getShadowColor()){ctx.shadowBlur=me.getShadowBlur();ctx.shadowColor=me.getShadowColor()}if(selectedFlag){me.paintSelected(ctx)}};this.paintSelected=function(ctx){ctx.shadowBlur="20";ctx.shadowColor="blue"};this.getNamePaintLocation=function(){return{}};var editor=null;this.getEditor=function(canvas){if(editor==null){editor=new EntityEditor(canvas,null,me)}return editor};this.paintLabelStyle=function(ctx){if(me.getLabelFontColor()){ctx.fillStyle=me.getLabelFontColor()}ctx.font="normal normal 100 "+me.getLabelFontSize()+" "+me.getLabelFont()};this.toString=function(){return'{id:"'+id+'",type:"'+me.getType()+'",name:"'+name+'",x:'+me.getX()+",y:"+me.getY()+",width:"+me.getWidth()+",height:"+me.getHeight()+(x2?(",x2:"+x2):"")+(y2?(",y2:"+y2):"")+',shadowColor:"'+shadowColor+'",shadowBlur:'+shadowBlur+"}"};var getOldStyle=function(ctx){return ctx.strokeStyle?ctx.strokeStyle:null}};
function Canvas(_canvas,bounds){var canvas=_canvas;var editor;var enableEditor=false;var enableMoving=true;var isReadonly=false;var libraries;var me=this;var name;var setBounds=function(bounds){canvas.x=bounds?bounds.x:0;canvas.y=bounds?bounds.y:0;canvas.width=bounds?bounds.width:1000;canvas.height=bounds?bounds.height:1000};if(bounds){setBounds(bounds)}var ctx=canvas.getContext("2d");var items=[];var getCanvasItems=function(){return items};var flickTime=1000;var flickStatus=true;var graphAction;this.ready=function(conf){flickTime=conf.flickTime?conf.flickTime:flickTime;flickStatus=conf.flickStatus?conf.flickStatus:flickStatus;name=conf.name?conf.name:uuid();if(flickStatus){initFlicker()}if(conf.backgroundColor){canvas.style.backgroundColor=conf.backgroundColor}if(conf.bounds){setBounds(conf.bounds)}if(conf.doMovedEntity){me.doMovedEntity=conf.doMovedEntity}if(conf.doStartMovingEntity){me.doStartMovingEntity=conf.doStartMovingEntity}if(conf.doAddedNewEntity){me.doAddedNewEntity=conf.doAddedNewEntity}if(conf.doAddingNewEntity){me.doAddingNewEntity=conf.doAddingNewEntity}if(conf.doLinked){me.doLinked=conf.doLinked}if(conf.doDropingEntity){me.doDropingEntity=conf.doDropingEntity}if(conf.doDropedEntity){me.doDropedEntity=conf.doDropedEntity}if(conf.doSelectEntity){me.doSelectEntity=conf.doSelectEntity}if(conf.doUnSelectEntity){me.doUnSelectEntity=conf.doUnSelectEntity}if(conf.doDeletingObject){me.doDeletingObject=conf.doDeletingObject}if(conf.doDeletedObject){me.doDeletedObject=conf.doDeletedObject}if(conf.doShowEntityEditor){me.doShowEntityEditor=conf.doShowEntityEditor}if(conf.doAddingText){me.doAddingText=conf.doAddingText}if(conf.doAddedText){me.doAddedText=conf.doAddedText}if(conf.doAddingGroup){me.doAddingGroup=conf.doAddingGroup}if(conf.doAddedGroup){me.doAddedGroup=conf.doAddedGroup}if(conf.getImageSrcPath){me.getImageSrcPath=conf.getImageSrcPath}};var imgTemplate;this.getTemplateImageNode=function(){if(imgTemplate){return imgTemplate}else{imgTemplate=document.getElementById("canvasTemplateImage")
}return imgTemplate};this.setLibraries=function(libs){libraries=libs};this.getLibraries=function(){return libraries};this.isShowEditor=function(){return enableEditor};this.readonly=function(o){if(o==undefined){return isReadonly}isReadonly=o};this.canMoving=function(o){if(o==undefined){return enableMoving}enableMoving=o};this.enableShowEditor=function(o){enableEditor=false};this.setEntityEditor=function(_editor){editor=_editor;editor.addEventListener("keydown",function(e){editorAction(e)},true)};this.getEntityEditor=function(){return editor};this.getBounds=function(){var b={};b.x=canvas.x;b.y=canvas.y;b.width=canvas.width;b.height=canvas.height;return b};this.getName=function(){return name};this.readyLink=function(o){graphAction=o?"link":null;linkSrcObj=null;linkDstObj=null};this.isReadyLink=function(){return graphAction=="link"};this.readyText=function(o){graphAction=o?"text":null;linkSrcObj=null;linkDstObj=null};this.isReadyText=function(){return graphAction=="text"};this.readyGroup=function(o){graphAction=o?"group":null;linkSrcObj=null;linkDstObj=null};this.isReadyGroup=function(){return graphAction=="group"};this.getItemByPoint=function(l){for(var i=items.length-1;i>=0;i--){var type=items[i].getType();if(type!="line"&&type!="group"&&items[i].isIn(l.x,l.y)){return items[i]}}for(var i=items.length-1;i>=0;i--){if(items[i].getType()=="line"&&items[i].isIn(l.x,l.y)){return items[i]}}var groups=me.getGroupEntities();for(var i=groups.length-1;i>=0;i--){if(groups[i].isIn(l.x,l.y)){return groups[i]}}return null};this.addItem=function(item){if(me.doAddingNewEntity){if(me.doAddingNewEntity(item)==false){return null}}for(var i=0;i<items.length;i++){if(items[i].getId()==item.getId()){return null}}items[items.length]=item;if(me.doAddedNewEntity){me.doAddedNewEntity(item)}return item};this.moveSelectItems=function(ev){if(me.canMoving()==false){return}var items=me.getSelectedItems();if((!items)||items.length==0){return}var x=0,y=0;var oft=ev.ctrlKey?1:3;switch(ev.key){case"ArrowDown":y=oft;
break;case"ArrowUp":y=-1*oft;break;case"ArrowLeft":x=-1*oft;break;case"ArrowRight":x=oft;break}var ln={};ln.x=x;ln.y=y;for(var i=0;i<items.length;i++){var item=items[i];if(item.getType()=="line"){continue}item.moveOft(ln)}};this.deleteItem=function(obj){var ids=[];ids[ids.length]=obj.getId();if(obj.isEntity()){var links=obj.getLines();log(links);if(links!=null){for(var i=0;i<links.length;i++){ids[ids.length]=links[i].getId()}}}else{if(obj.getType()=="line"){}}var isInArray=function(arr,str){for(var i=0;i<arr.length;i++){if(arr[i]==str){return true}}return false};var newItems=[];for(var i=0;i<items.length;i++){if(isInArray(ids,items[i].getId())){var objDeleted=items[i];if(me.doDeletingObject&&(me.doDeletingObject(objDeleted)==false)){return}items[i]=null;if(me.doDeletedObject){me.doDeletedObject(objDeleted)}continue}newItems[newItems.length]=items[i]}items=newItems;me.repaint()};this.getItem=function(id){for(var i=0;i<items.length;i++){if(items[i].getId()==id){return items[i]}}return null};this.getGroupEntities=function(){var rs=[];for(var i=0;i<items.length;i++){if(items[i].getType()=="group"){rs[rs.length]=items[i]}}return rs};this.autoAttachEntityToGroup=function(entity){var groups=me.getGroupEntities();for(var i=0;i<groups.length;i++){if(boundsInclude(groups[i].bounds(),entity.bounds())){if(entity.isInGroup()==false){groups[i].addMember(entity)}}else{groups[i].removeMember(entity)}}};this.getPathByNodes=function(nodeIds){var ok=nodeIds&&nodeIds.length>1;if(ok==false){return[]}var node=me.getItem(nodeIds[0]);var lines=node.getLines();var paths=[];paths[paths.length]=node;for(var i=0;i<nodeIds.length;i++){var nid=nodeIds[i];node=me.getItem(nid);for(var j=0;j<lines.length;j++){var l=lines[j];if(l.getFromObj().getId()==nid||l.getToObj().getId()==nid){paths[paths.length]=l;paths[paths.length]=node;break}}lines=node.getLines()}return paths};this.getSelectedItems=function(){var arr=[];for(var i=0;i<items.length;i++){if(items[i].isSelected()){arr[arr.length]=items[i]}}return arr
};this.unSelectItems=function(){for(var i=0;i<items.length;i++){if(items[i].isSelected()){items[i].selected(false)}}};this.getItems=function(){return items};this.setFlickTime=function(millionTime){flickTime=millionTime};this.paintToolBar=function(){};this.repaint=function(){ctx.shadowBlur=0;me.paintBackground();ctx.save();me.paintGroups();ctx.save();me.paintLines();ctx.save();me.paintEntitys();me.paintToolBar()};this.paintBackground=function(){ctx.rect(canvas.x,canvas.y,canvas.width,canvas.height);ctx.fillStyle=canvas.style.backgroundColor;ctx.fill()};this.paintGroups=function(){for(var i=0;i<items.length;i++){if(items[i].getType()=="group"){items[i].paint(ctx);ctx.shadowBlur=0}}};this.paintLines=function(){for(var i=0;i<items.length;i++){if(items[i].getType()=="line"){items[i].paint(ctx);ctx.shadowBlur=0}}};this.paintEntitys=function(){for(var i=0;i<items.length;i++){var type=items[i].getType();if(type!="line"&&type!=="group"){items[i].paint(ctx);ctx.shadowBlur=0}}};var util=new CanvasUtil();this.importDocument=function(json){util.importEntities(me,json)};this.exportDocument=function(){var json=util.exportEntitiesToJson(me);return json};var copiedItems;this.doCopyAction=function(){copiedItems=me.getSelectedItems()};this.doPasteAction=function(){if(copiedItems){var _m=[];var _lines=[];for(var i=0;i<copiedItems.length;i++){var item=copiedItems[i];if(item.clone){var newItem=item.clone();me.addItem(newItem);_m[item.getId()]=newItem.getId();if(item.getType()=="line"){_lines[_lines.length]=newItem;newItem.setFromObj(item.getFromObj());newItem.setToObj(item.getToObj())}}}if(_lines.length>0){for(var i=0;i<_lines.length;i++){var l=_lines[i],fid=_m[l.getFromObj().getId()],tid=_m[l.getToObj().getId()];var fromObj=fid?me.getItem(fid):null;var toObj=tid?me.getItem(tid):null;if(fromObj){l.setFromObj(fromObj)}if(toObj){l.setToObj(toObj)}}}}};var dragingLn;this.setDragEntityOffset=function(ln){dragingLn=ln};var actionRecorder=new ActionRecorder(me);this.setActionRecorder=function(recorder){actionPointerIndex=-1;
actionRecorder=recorder};var actionPointerIndex=-1;this.doCancel=function(){if(actionPointerIndex<0){return}actionRecorder.performDoCancel(actionPointerIndex);actionPointerIndex--};this.doRecordAction=function(record){actionRecorder.recordAction[record,actionPointerIndex++]};var getMouseOnObj=function(x,y){return me.getItemByPoint({x:x,y:y})};var dragObj=null;var dragObjHistory=null;var linkSrcObj;var linkDstObj;var findLinkingToEntity=function(x,y){var obj=getMouseOnObj(x,y);if(obj){if(obj.getType()=="line"){return null}}return obj};canvas.onmousedown=function(e){if(me.readonly()){return}var x=e.offsetX;var y=e.offsetY;if(me.isReadyLink()){linkSrcObj=findLinkingToEntity(x,y);if(dragObjHistory){dragObjHistory.selected(false);if(me.doUnSelectEntity){me.doUnSelectEntity(dragObjHistory)}}hiddenEditor(dragObjHistory);return}if(me.isReadyText()){if(me.doAddingText){var newTxt=me.doAddingText(e);if(doAddNewTxt(newTxt,x,y,e)){me.readyText(false)}}me.repaint();return}if(me.isReadyGroup()){if(me.doAddingGroup){var newGroup=me.doAddingGroup(e);if(doAddNewGroup(newGroup,x,y,e)){me.readyGroup(false)}}me.repaint();return}dragObj=getMouseOnObj(x,y);if(dragObj!=null){try{if(me.doSelectEntity){me.doSelectEntity(dragObj)}if(dragObjHistory&&dragObjHistory!=dragObj){if(e.ctrlKey==false){dragObjHistory.selected(false);if(me.doUnSelectEntity){me.doUnSelectEntity(dragObjHistory)}me.unSelectItems()}hiddenEditor(dragObjHistory)}dragObj.selected(true);if(doubleClick(e)){showEditor(x,y,dragObj,e)}if(me.doStartMovingEntity&&isMouseDraging(e)){me.doStartMovingEntity(dragObj)}}catch(ex){}}else{if(dragObjHistory){if(e.ctrlKey==false){dragObjHistory.selected(false);if(me.doUnSelectEntity){me.doUnSelectEntity(dragObjHistory)}me.unSelectItems()}}hiddenEditor(dragObjHistory)}if(isMouseDraging(e)){pointDrawingRect={};pointDrawingRect.x=x;pointDrawingRect.y=y}me.repaint();dragObjHistory=dragObj};var isDrawingRect=false;var isDrawingRect=false;canvas.onmouseup=function(e){if(me.readonly()){return}var x=e.offsetX;
var y=e.offsetY;if(me.isReadyText()||me.isReadyGroup()){return}if(me.isReadyLink()){if(linkSrcObj){linkDstObj=findLinkingToEntity(x,y);if(linkDstObj&&linkSrcObj!=linkDstObj){var newLine=doLinkEntityByMouseEvent(linkSrcObj,linkDstObj);if(me.doLinked){try{me.doLinked(newLine);me.readyLink(false)}catch(ex){}}}linkSrcObj=null;linkDstObj=null;oldSrcEntityWhenLinking=null;me.repaint()}return}if(dragObj!=null){try{if(me.doMovedEntity){me.doMovedEntity(dragObj)}}catch(ex){}dragObj=null}else{console.log("...................");me.unSelectItems()}if(isDrawingRect){doSelectInDrawRect(x,y);releasePaintDrawRect()}me.repaint()};var oldSrcEntityWhenLinking=null;canvas.onmousemove=function(e){if(me.readonly()){return}var x=e.offsetX;var y=e.offsetY;if(me.isReadyText()||me.isReadyGroup()){return}if(me.isReadyLink()){var obj=findLinkingToEntity(x,y);if(obj){if(oldSrcEntityWhenLinking!=obj){obj.paintSelected(ctx);obj.paint(ctx);oldSrcEntityWhenLinking=obj}}else{me.repaint();oldSrcEntityWhenLinking=null}}if(isMouseFree(e)){dragObj=null;return}if(me.isReadyLink()){if(linkSrcObj){me.repaint();paintReadLink(linkSrcObj,x,y)}return}if(dragObj==null){me.repaint();paintDrawRect(x,y);isDrawingRect=true;return}if(me.canMoving()&&dragObj!=null&&dragObj.canMoving()){var ln={};ln.x=x-dragObj.getX()-dragObj.getOftX();ln.y=y-dragObj.getY()-dragObj.getOftY();var items=me.getSelectedItems();for(var i=0;i<items.length;i++){var item=items[i];if(item.getType()=="line"){continue}item.moveOft(ln)}}if(dragObj!=null){me.repaint()}};canvas.ondragover=function(ev){if(me.readonly()){return}ev.preventDefault()};canvas.ondrop=function(ev){if(me.readonly()){return}ev.preventDefault();var data=me.doDropingEntity(ev);if(!data){console.log("Can not find the data for drop entity!");return}var x=ev.offsetX;var y=ev.offsetY;if(dragingLn){x=x-dragingLn.x;y=y-dragingLn.y}var entity=new Image(uuid(),data.name,data.image,x,y);if(entity.getType()=="image"){var att={};att.name="imageType";att.value=data.type;entity.addExtProperties(att);
entity.setImageType(data.type)}me.addItem(entity);if(me.doDropedEntity){me.doDropedEntity(entity)}me.repaint()};canvas.keydown=function(ev){if(me.readonly()){return}switch(ev.key){case"Delete":var selecteds=me.getSelectedItems();for(var i=0;i<selecteds.length;i++){me.deleteItem(selecteds[i])}break;case"ArrowDown":me.moveSelectItems(ev);break;case"ArrowRight":me.moveSelectItems(ev);break;case"ArrowLeft":me.moveSelectItems(ev);break;case"ArrowUp":me.moveSelectItems(ev);break;case"c":if(ev.ctrlKey){me.doCopyAction()}break;case"C":if(ev.ctrlKey){me.doCopyAction()}break;case"v":if(ev.ctrlKey){me.doPasteAction()}break;case"V":if(ev.ctrlKey){me.doPasteAction()}break;case"Z":if(ev.ctrlKey){me.doCancel()}break;case"z":if(ev.ctrlKey){me.doCancel()}break}me.repaint()};var doAddNewTxt=function(data,x,y,ev){var txt=new Text(uuid(),data.name,x,y,data.content,data.color,data.font,data.size);me.addItem(txt);if(me.doAddedText){me.doAddedText(txt)}return true};var doAddNewGroup=function(data,x,y,ev){var group=new EntityGroup(uuid(),data.name,x,y,autoParseNumber(data.width,100),autoParseNumber(data.height,100),data.color?data.color:"lightgray");me.addItem(group);if(me.addedGroup){me.addedGroup(group)}return true};var doLinkEntityByMouseEvent=function(src,dst){var uid=uuid();var linkLabel=src.getName()+","+dst.getName();var x1=src.getCenterX(),y1=src.getCenterY(),x2=dst.getCenterX(),y2=dst.getCenterY();var l=new Line(uid,linkLabel,x1,y1,x2,y2,2,"black");l.setFromObj(src);l.setToObj(dst);src.addLine(l);dst.addLine(l);l.relocationFrom();l.relocationTo();me.addItem(l);return l};var pointDrawingRect;var releasePaintDrawRect=function(){pointDrawingRect=null;isDrawingRect=false;me.repaint()};var doSelectInDrawRect=function(x2,y2){var x=pointDrawingRect.x,y=pointDrawingRect.y;var b={};b.x=Math.min(x,x2);b.y=Math.min(y,y2);b.width=Math.abs(x-x2);b.height=Math.abs(y-y2);var its=me.getItems();for(var i=0;i<its.length;i++){var item=its[i];if(boundsInclude(b,item.bounds())){item.selected(true)}}};var paintDrawRect=function(x2,y2){var x=pointDrawingRect.x,y=pointDrawingRect.y;
ctx.save();ctx.beginPath();ctx.strokeStyle="red";ctx.strokeRect(x,y,x2-x,y2-y);ctx.stroke();ctx.restore()};var paintReadLink=function(srcObj,x,y){srcObj.paintSelected(ctx);srcObj.paint(ctx);var obj=findLinkingToEntity(x,y);if(obj){obj.paintSelected(ctx);obj.paint(ctx)}ctx.save();ctx.beginPath();ctx.strokeStyle="red";ctx.lineWidth=2;ctx.beginPath();var x0=srcObj.getCenterX();var y0=srcObj.getCenterY();ctx.moveTo(x0,y0);ctx.lineTo(x,y);ctx.closePath();ctx.stroke();ctx.restore()};var initFlicker=function(){};var isMouseDraging=function(e){return e.buttons==1&&e.detail==1};var isMouseFree=function(e){return e.buttons==0&&e.detail==0};var doubleClick=function(e){return e.buttons==1&&e.detail==2};var entityEditor;var hiddenEditor=function(obj){if(entityEditor){entityEditor.hidden();entityEditor=null}me.repaint()};var showEditor=function(x,y,obj,ev){if(me.doShowEntityEditor){me.doShowEntityEditor(obj,ev)}else{if(me.enableShowEditor()==false){return}entityEditor=obj.getEditor(me);log("********************************Entity editor: "+canvas.offsetLeft+","+canvas.offsetTop);log(canvas);log(ev);if(entityEditor){entityEditor.show(x,y,ev);entityEditor.focus()}else{log("Can not get the editor for node "+obj.toString())}}};window.addEventListener("keydown",function(e){var node=e.target||e.srcElement;if(node.nodeName=="BODY"){canvas.keydown(e)}},true);var editorAction=function(ev){var selecteds=me.getSelectedItems();if(selecteds&&selecteds.length==1){var view=selecteds[0].getEditor(me);if(ev.key=="Enter"){view.update();hiddenEditor()}else{view.autoResizeEditorField()}}};return this}var uuid=function(){var s=[];var hexDigits="0123456789abcdef";for(var i=0;i<32;i++){s[i]=hexDigits.substr(Math.floor(Math.random()*16),1)}s[14]="4";s[19]=hexDigits.substr((s[19]&3)|8,1);var uuid=s.join("");return uuid};var translateFontSize=function(fsize){if(fsize.indexOf("px")){var v=fsize.substring(0,fsize.length-2);return v}else{return fsize}};var canvasTextWidth=function(obj,str){var len=textWidth(str);
var fsize=obj.getLabelFontSize();fsize=fsize?fsize:"15px";var v=translateFontSize(fsize);var w=((parseFloat(v)*len)/19.66).toFixed(0);return w};var canvasTextBounds=function(fontSize,str){var len=textWidth(str);var fsize=fontSize;fsize=fsize?fsize:"15px";var rs={};rs.height=parseFloat(translateFontSize(fsize));rs.width=((rs.height*len)/2);return rs};var textWidth=function(str){var realLength=0,len=str.length,charCode=-1;for(var i=0;i<len;i++){charCode=str.charCodeAt(i);if(charCode>=0&&charCode<=128){realLength+=1}else{realLength+=2}}return realLength};var pointDistance=function(p1,p2){var x=p1.x-p2.x;var y=p1.y-p2.y;return Math.sqrt(x*x+y*y)};var boundsInclude=function(b1,b2){var rs=b2.x>=(b1.x-b2.width/2)&&(b1.x+b1.width)>(b2.x+b2.width/2);rs=rs&&b2.y>=(b1.y-b2.height/2)&&(b1.y+b1.height)>(b2.y+b2.height/2);log(b1,b2);return rs};var boundsNotConnect=function(b1,b2){};var createBlankImage=function(){console.log("TODO create blank image for image entity.")};var autoParseNumber=function(v,defValue){var tf=typeof(v);return tf=="string"?parseInt(v):tf=="number"?v:defValue?defValue:0};var log=function(msg,obj){if(true){return}if(obj){console.log(msg,obj)}else{console.log(msg)}};
function Text(id,name,x,y,_content,color,font,size){ShapeEntity.call(this,id,name);this.getType=function(){return"text"};var me=this;var superPaint=me.paint;var superGetY=me.getY;var superIsIn=me.isIn;var superGetWidth=me.getWidth;var content;if(x){me.setX(x)}if(y){me.setY(y)}if(_content){content=_content}this.getContent=function(){var lab=content?content:me.getName();return lab};this.setContent=function(str){content=str};if(color){me.setLabelFontColor(color)}if(font){me.setLabelFont(font)}if(size){me.setLabelFontSize(size)}this.getWidth=function(){var lab=me.getContent();var w=0;if(lab){var arr=lab.split("\n");for(var i=0;i<arr.length;i++){w=Math.max(w,canvasTextBounds(me.getLabelFontSize(),arr[i]).width)}}return w};this.getHeight=function(){var lab=me.getContent();if(lab){var h=canvasTextBounds(me.getLabelFontSize(),lab).height;var arr=lab.split("\n");return h*arr.length+h/4}return 0};this.isIn=function(px,py){superIsIn(px,py);var oftX=px-me.getX();var oftY=py-me.getY();var lab=me.getContent();var arr=lab.split("\n");var len=arr.length;var bounds={};bounds.width=me.getWidth();bounds.height=me.getHeight();var rs=oftX>0&&oftX<bounds.width&&oftY>(-1*(bounds.height/len))&&oftY<((bounds.height-bounds.height/len));return rs};this.paint=function(ctx){var lab=me.getContent();superPaint(ctx);me.paintLabelStyle(ctx);var b=canvasTextBounds(me.getLabelFontSize(),me.getContent());var arr=lab.split("\n");for(var i=0;i<arr.length;i++){ctx.fillText(arr[i],me.getX(),me.getY()+i*b.height)}};this.clone=function(){var w=me.getWidth();var h=me.getHeight();var rs=new Text(uuid(),me.getName(),me.getX()+w+32,me.getY()+h+32,me.getContent(),me.getLabelFontColor(),me.getLabelFont(),me.getLabelFontSize());rs.setShadowColor(me.getShadowColor());rs.setShadowBlur(me.getShadowBlur());return rs};this.bounds=function(){var b={};b.x=me.getX();b.y=me.getY();b.width=me.getWidth();b.height=me.getHeight();b.y=b.y-b.height;return b};this.getNamePaintLocation=function(){var rs={};rs.x=me.getX();rs.y=superGetY();
rs.w=textWidth(me.getContent());rs.h=me.getHeight();return rs};var editor=null;this.getEditor=function(canvas){if(editor==null){editor=new TextEditor(canvas,null,me)}return editor}};
